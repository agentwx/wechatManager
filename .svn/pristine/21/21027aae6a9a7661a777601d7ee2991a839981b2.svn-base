#! /usr/local/bin/python3
# -*- coding: utf-8 -*-
from ..itchat.returnvalues import ReturnValue
import io

msgDic = {}
file_type_list = ['Picture', 'Recording', 'Video', 'Attachment']


# {msg_id:(msg_from,msg_to,msg_from_id, msg_time,msg_time_touser,msg_type,msg_content,msg_url)}

def saveMessage(msg):
    types = msg['Type']
    if types in ["System"]: return

    print(types)
    if types in ["Picture", "Recording", "Attachment", "Video"]:
        pass



def isRevokeMsg(msg):
    pass


def getVideoImg(msg_id, downloadDir=None):
    params = {
        'msgid': msg_id,
        'type': 'slave',
        'skey': itchat.originInstance.loginInfo['skey'],
    }   
    headers = { 'User-Agent' : USER_AGENT }
    url = '%s/webwxgetmsgimg' % (itchat.originInstance.loginInfo['url'])
    
    wechatLog.debug('url: %s' % (url + '?' + json.dumps(params)))
    
    r = itchat.originInstance.s.get(url, params=params, stream=True, headers = headers)
    tempStorage = io.BytesIO()
    for block in r.iter_content(1024):
        tempStorage.write(block)
    if downloadDir is None: return tempStorage.getvalue()

    with open(downloadDir, 'wb') as f: f.write(tempStorage.getvalue())
    return ReturnValue({'BaseResponse': {
        'ErrMsg': 'Successfully downloaded',
        'Ret': 0, }})

def clearTimeoutMsg():
    if len(msgDic) > 0:
        for msgid in list(msgDic):
            if time.time() - msgDic[msgid]['msgTime'] > 130.0: #time out
                item = msgDic.pop(msgid)
                wechatLog.debug(u'time out msg: ' + item['msgContent'])
                if item['msgType'] in file_type_list:
                    wechatLog.debug(u'need to delete file: ' + item['msgContent'])
                    os.remove(item['msgContent'])


def wechat(msg):
    wechatLog.debug(msg)
    msgFromId = msg['FromUserName']
    if msgFromId == itchat.originInstance.storageClass.userName: #if the msg from myself ignore it
        return
    msgFromNickName = itchat.search_friends(userName=msgFromId)['NickName'] #消息发送人昵称
    localTime = time.localtime()
    msgTimeTouser = getDate()
    msgId = msg['MsgId']

    msgTime = msg['CreateTime']
    msgType = msg['Type']
    msgContent = None
    msgUrl = None

    if msgType == 'Text':
        msgContent = msg['Text'];
    elif msgType == 'Picture':
        msgContent = msg['FileName']
        msg['Text'](msgContent)

    elif msgType == 'Card':
        msgContent = msg['RecommendInfo']['NickName'] + u' 的名片'
    elif msgType == 'Map':
        x, y, location = re.search("<location x=\"(.*?)\" y=\"(.*?)\".*label=\"(.*?)\".*", msg['OriContent']).group(1,2,3)
        #msg_content = u"纬度->" + str(x) + " 经度->" + str(y) + " " + location
        msgContent = location

    elif msgType == 'Sharing':
        msgContent = msg['Text'] + '\t' + msg['Url']
        msgUrl = msg['Url']
    elif msgType == 'Recording':
        msgContent = msg['FileName']
        msg['Text'](msgContent)

    elif msgType == 'Attachment':
        msgContent = msg['FileName']
        msg['Text'](msgContent)

    elif msgType == 'Video':
        msgType = 'Picture'  #无法获取video 只能先获取静态图片把
        suffix = msg['FileName'].find('.')
        if suffix == -1: return
        msgContent = msg['FileName'][0:suffix] + '.jpg'
        wechatLog.debug(msgContent)
        getVideoImg(msg_id, msgContent) 

    #更新字典
    # {msg_id:(msg_from,msg_time,msg_time_touser,msg_type,msg_content,msg_url)}
    msgDic.update({msgId: 
        {
        "msgFromNickName": msgFromNickName, 
        "msgFromId": msgFromId,
        "msgTime": msgTime, 
        "msgTimeTouser": msgTimeTouser, 
        "msgType": msgType,
        "msgContent": msgContent, 
        "msgUrl": msgUrl}
        })
    #清理字典
    clearTimeoutMsg()
    if msgType == 'Text':
        itchat.send(getResponse(msgContent) or u'你说啥?', msgFromId)

def revoke(msg):
    wechatLog.debug(msg)
    for s in WITHDRAW:
        msgFlag = msg['Content'].find(s)
        if msgFlag != -1: break

    if msgFlag != -1:
        oldMsgId = re.search(r'\<msgid\>(.+?)\<\/msgid\>', msg['Content']).group(1)
        oldMsg = msgDic.get(oldMsgId, None)
        if oldMsg == None: #if yourself withdraw msg
            return
        wechatLog.debug(oldMsg)
        if oldMsg['msgType'] in [PICTURE, RECORDING, ATTACHMENT, VIDEO]: #{'Picture': 'img', 'Video': 'vid'}
            itchat.send('@%s@%s' % ({'Picture': 'img', 'Video': 'vid'}.get(oldMsg['msgType'], 'fil'), oldMsg['msgContent']), toUserName = oldMsg['msgFromId'])

        elif oldMsg['msgType'] in [TEXT, MAP, CARD, NOTE, SHARING]:
            itchat.send(oldMsg['msgContent'], toUserName = oldMsg['msgFromId'])

        item = msgDic.pop(oldMsgId)
        wechatLog.debug(u'already return: ' + item['msgContent'])
        if item['msgType'] in file_type_list:
            wechatLog.debug(u'need to delete file: ' + item['msgContent'])
            os.remove(item['msgContent'])
        
    clearTimeoutMsg()
    return None