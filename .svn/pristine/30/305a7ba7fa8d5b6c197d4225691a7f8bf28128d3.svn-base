#! /usr/local/bin/python3
# -*- coding: utf-8 -*-
# 
import os, datetime, time, re

from ..wechatRecord import *

from ..itchat import config
from ..itchat.components.login import process_login_info
from ..itchat.core import Core

def relativePath(path, relate=os.getcwd()):
    index = 0
    for i in path:
        #print("i = ", i)
        if index > len(relate)-1: return path[index+1:]
        if i == relate[index]:
            index += 1
    return None


def getDate():
    now = datetime.datetime.now()
    return now.strftime('%Y-%m-%d %H:%M:%S')

def checkLogin(self, uuid=None):
    uuid = uuid or self.uuid
    url = '%s/cgi-bin/mmwebwx-bin/login' % config.BASE_URL
    localTime = int(time.time())
    params = 'loginicon=true&uuid=%s&tip=1&r=%s&_=%s' % (
    uuid, int(-localTime / 1579), localTime)
    headers = { 'User-Agent' : config.USER_AGENT }
    r = self.s.get(url, params=params, headers=headers)
    regx = r'window.code=(\d+)'
    regxForHeadImg = r"window.code=201;window.userAvatar = '(\S+)';"
    data = re.search(regx, r.text)
    if data and data.group(1) == '200':
        if process_login_info(self, r.text):
            return '200'
        else:
            return '400'
    elif data:
        if data.group(1) == '201': #get head img
            headImg = re.search(regxForHeadImg, r.text).group(1)
            recordeStatus({"headImg":headImg})
        return data.group(1)
    else:
        return '400'


Core.check_login = checkLogin #替换掉itchat的check_login
